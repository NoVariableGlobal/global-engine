#include "InvulnerabilityShield.h"
#include "Entity.h"
//#include "FloorComponent.h"
#include "ComponentsManager.h"
#include "FactoriesFactory.h"
#include "OgreVector3.h"
#include "Scene.h"
#include "TransformComponent.h"
#include "TridimensionalObjectRC.h"
#include "RigidbodyPC.h"
#include "Factory.h"
#include "LifeC.h"
#include <iostream>
#include <json.h>

InvulnerabilityShield::InvulnerabilityShield() {}

InvulnerabilityShield::~InvulnerabilityShield() {}

void InvulnerabilityShield::checkEvent() {
    PowerUpEC::checkEvent();

    if (!picked && getCollisionWithPlayer()) {
        LifeC* playerHealth = dynamic_cast<LifeC*>(
            scene->getEntitybyId("Player")->getComponent("LifeC"));
        playerHealth->setInvulnerability(true);
        picked = true;

        //remove render component
        scene->getComponentsManager()->eraseRC(
            (dynamic_cast<TridimensionalObjectRC*>(father->getComponent("TridimensionalObjectRC"))));
        scene->getComponentsManager()->erasePC((dynamic_cast<RigidbodyPC*>(
                father->getComponent("RigidbodyPC"))));
        scene->getComponentsManager()->eraseDC(
            (dynamic_cast<TransformComponent*>(father->getComponent("TransformComponent"))));
    }
    if (!picked) { // delete item when the effect has passed
        if (timeDisappear()) {
            // TODO: Delete the entire object
            scene->getComponentsManager()->eraseEC(this);

            /*RenderComponent* render = dynamic_cast<RenderComponent*>(
                scene->getEntitybyId("Shield0")->getComponent(
                    "TridimensionalObjectRC"));
            compManager->deleteRC(render);
            delete this;*/
        }
    } else if (timeDisappearEffect()) {
            // TODO: Delete the entire object
        std::cout << "Passed effect\n";
        LifeC* playerHealth = dynamic_cast<LifeC*>(
            scene->getEntitybyId("Player")->getComponent("LifeC"));
        playerHealth->setInvulnerability(false);

        scene->getComponentsManager()->eraseEC(this);
        // TODO: Delete the entire object
    }
}

void InvulnerabilityShield::setTimeEffect(float _time) { timeEffect = _time; }

bool InvulnerabilityShield::timeDisappearEffect() {
    float seconds = clock() / static_cast<float>(CLOCKS_PER_SEC);

    if (!startPicked) {
        time = seconds;
        startPicked = true;
    }
    if (time + timeEffect <= seconds) {
        return true;
    }

    return false;
}

// FACTORY INFRASTRUCTURE
class InvulnerabilityShieldFactory final : public ComponentFactory {
  public:
    InvulnerabilityShieldFactory() = default;

    Component* create(Entity* _father, Json::Value& _data,
                      Scene* scene) override {
        InvulnerabilityShield* invulnerability_Shield =
            new InvulnerabilityShield();

        invulnerability_Shield->setFather(_father);
        invulnerability_Shield->setScene(scene);
        scene->getComponentsManager()->addEC(invulnerability_Shield);

        if (!_data["time"].isDouble())
            throw std::exception("Shield: time is not a double");
        invulnerability_Shield->setDuration(_data["time"].asDouble());

        if (!_data["timeEffect"].isDouble())
            throw std::exception("Shield: timeEffect is not a double");
        invulnerability_Shield->setTimeEffect(_data["timeEffect"].asDouble());

        invulnerability_Shield->setActive(true);

        return invulnerability_Shield;
    };
};

REGISTER_FACTORY("InvulnerabilityShield", InvulnerabilityShield);